<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Live Audio Connection</title>
</head>
<body>
    <h1>WebSocket Audio and Text Response</h1>
    <button onclick="startRecording()">Start Recording</button>
    <button onclick="stopRecording()">Stop Recording</button>

    <p id="textResponse"></p>
    <audio id="audioPlayback" controls></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.0/socket.io.js"></script>
    <script type="text/javascript">
        let mediaRecorder;
        let socket = io.connect('http://localhost:5000'); // Adjust the URL to match your server

        // Clear the previous audio and reset the buffer
        function clearAudioPlayback() {
            const audioElement = document.getElementById('audioPlayback');
            if (audioElement.src) {
                URL.revokeObjectURL(audioElement.src); // Revoke any previously set Blob URL
            }
            audioElement.src = ''; // Clear the audio source
        }

        // Start recording and send audio chunks to the server
        function startRecording() {
            clearAudioPlayback();
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm; codecs=opus',
                        audioBitsPerSecond: 192000
                    });

                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) {
                            socket.emit('audio_chunk', event.data);
                        }
                    };

                    mediaRecorder.start(250); // Capture audio chunks every 250ms
                    socket.emit('start_recording'); // Notify the server
                })
                .catch(error => console.error("Error accessing microphone:", error));
        }

        // Stop recording and notify the server
        function stopRecording() {
            mediaRecorder.stop();
            socket.emit('audio_stop');
        }

        // Display the text response
        socket.on('text_response', data => {
            const textElement = document.getElementById('textResponse');
            textElement.innerText = `Response: ${data.text}`;
        });

        // Play the streamed audio
        let audioChunks = [];
        socket.on('audio_stream', audioChunk => {
            audioChunks.push(audioChunk);
        });

        // Once streaming is complete, play the full audio
        socket.on('audio_complete', () => {
            const audioElement = document.getElementById('audioPlayback');
            const blob = new Blob(audioChunks, { type: 'audio/webm; codecs=opus' });
            const audioUrl = URL.createObjectURL(blob);
            audioElement.src = audioUrl;
            audioElement.play();
            audioChunks = []; // Reset audio chunks for next session
        });
    </script>
</body>
</html>
